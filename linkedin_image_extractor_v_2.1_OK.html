<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LinkedIn Image Extractor V2.1.1</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body { font-family:Segoe UI,Tahoma,Geneva,Verdana,sans-serif; background:linear-gradient(135deg,#0077b5,#00a0dc); min-height:100vh; padding:20px; }
    .container { max-width:1200px; margin:0 auto; background:#fff; border-radius:15px; box-shadow:0 20px 40px rgba(0,0,0,.1); overflow:hidden; }
    .header { background:linear-gradient(135deg,#0077b5,#004182); color:#fff; padding:30px; text-align:center; }
    .header h1 { font-size:2.5em; margin-bottom:10px; font-weight:300; }
    .header p { opacity:.9; font-size:1.1em; }
    .main-content { padding:40px; }
    .input-section { margin-bottom:40px; }
    .input-group { display:flex; gap:15px; margin-bottom:20px; }
    input[type=url] { flex:1; padding:15px 20px; border:2px solid #e1e5e9; border-radius:10px; font-size:16px; transition:.3s; }
    input[type=url]:focus { outline:none; border-color:#0077b5; box-shadow:0 0 0 3px rgba(0,119,181,.1); }
    .extract-btn { background:linear-gradient(135deg,#0077b5,#00a0dc); color:#fff; border:none; padding:15px 30px; border-radius:10px; font-size:16px; font-weight:600; cursor:pointer; transition:.3s; white-space:nowrap; }
    .extract-btn:hover { transform:translateY(-2px); box-shadow:0 10px 20px rgba(0,119,181,.3); }
    .extract-btn:disabled { background:#ccc; cursor:not-allowed; }
    .loading { display:none; text-align:center; padding:20px; }
    .spinner { width:50px; height:50px; border:5px solid #f3f3f3; border-top:5px solid #0077b5; border-radius:50%; animation:spin 1s linear infinite; margin:0 auto 20px; }
    @keyframes spin { 0%{transform:rotate(0)} 100%{transform:rotate(360deg)} }
    .results { margin-top:30px; }
    .status { padding:15px; border-radius:10px; margin-bottom:20px; font-weight:500; }
    .status.success { background:#d4edda; color:#155724; border:1px solid #c3e6cb; }
    .status.error { background:#f8d7da; color:#721c24; border:1px solid #f5c6cb; }
    .status.info { background:#d1ecf1; color:#0c5460; border:1px solid #bee5eb; }
    .images-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
    .image-card { background:#f8f9fa; border-radius:15px; padding:20px; box-shadow:0 5px 15px rgba(0,0,0,.1); transition:.3s; }
    .image-card:hover { transform:translateY(-5px); }
    .image-card img, .image-card video { width:100%; height:200px; object-fit:cover; border-radius:10px; margin-bottom:15px; cursor:pointer; background:#e9ecef; }
    .image-info { margin-bottom:15px; }
    .image-url { font-size:.8em; color:#666; word-break:break-all; margin-bottom:10px; padding:10px; background:#f0f0f0; border-radius:5px; }
    .image-actions { display:flex; gap:10px; }
    .download-btn, .copy-btn, .open-btn { flex:1; border:none; padding:8px 12px; border-radius:6px; font-size:12px; cursor:pointer; }
    .download-btn { background:#28a745; color:#fff; }
    .download-btn:hover { background:#218838; }
    .copy-btn { background:#6c757d; color:#fff; }
    .copy-btn:hover { background:#5a6268; }
    .open-btn { background:#007bff; color:#fff; }
    .open-btn:hover { background:#0056b3; }
    .debug-info { background:#f8f9fa; border-radius:10px; padding:20px; margin-top:20px; font-family:monospace; font-size:.9em; max-height:300px; overflow-y:auto; }
    .note { font-size:.8em; margin-top:6px; }
    .note.warn { color:#b02a37; }
    @media (max-width:768px){ .input-group{flex-direction:column;} .header h1{font-size:2em;} .main-content{padding:20px;} .images-grid{grid-template-columns:1fr;} }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üñºÔ∏è LinkedIn Image Extractor V2.1.1</h1>
      <p>Estrai immagini e video da un post LinkedIn (con diagnostica errori) - *** Se Errore http 200, prova comunque *** </p>
    </div>
    <div class="main-content">
      <div class="input-section">
        <div class="input-group">
          <input type="url" id="linkedinUrl" placeholder="Incolla qui il link del post LinkedIn..." />
          <button class="extract-btn" onclick="extractImages()">Scansiona Post</button>
        </div>
      </div>
      <div class="loading" id="loading">
        <div class="spinner"></div>
        <p>Scansionando il post LinkedIn...</p>
      </div>
      <div class="results" id="results"></div>
    </div>
  </div>

  <script>
    // Cache per evitare probe ripetute dello stesso URL
    const probeCache = new Map(); // url -> { status, statusText, errorMessage }

    function getFallbackDataUrl(){
      const svg = "<svg xmlns='http://www.w3.org/2000/svg' width='300' height='200'><rect width='100%' height='100%' fill='#cccccc'/><text x='50%' y='50%' dominant-baseline='middle' text-anchor='middle' fill='#666666' font-size='14'>Media non disponibile</text></svg>";
      return 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
    }

    async function probeUrl(url){
      if (probeCache.has(url)) return probeCache.get(url);
      const controller = new AbortController();
      const timeout = setTimeout(() => controller.abort(), 5000);
      try {
        const resp = await fetch(url, { method:'HEAD', cache:'no-store', redirect:'follow', signal: controller.signal });
        clearTimeout(timeout);
        const info = { status: resp.status, statusText: resp.statusText || '', errorMessage: '' };
        probeCache.set(url, info);
        return info;
      } catch (e) {
        clearTimeout(timeout);
        // Possibile CORS o rete. Salvo l'errore per evitare loop di retry.
        const info = { status: 0, statusText: '', errorMessage: e.message || 'Network error' };
        probeCache.set(url, info);
        return info;
      }
    }

    async function extractImages(){
      const url = document.getElementById('linkedinUrl').value.trim();
      const loadingDiv = document.getElementById('loading');
      const resultsDiv = document.getElementById('results');
      const extractBtn = document.querySelector('.extract-btn');
      if (!url){ showStatus('error','Per favore inserisci un URL valido'); return; }
      if (!url.includes('linkedin.com')){ showStatus('error', "L'URL deve essere di LinkedIn"); return; }
      resultsDiv.innerHTML = '';
      loadingDiv.style.display = 'block';
      extractBtn.disabled = true; extractBtn.textContent = 'Scansionando...';
      try {
        const proxies = [
          'https://api.allorigins.win/raw?url=',
          'https://corsproxy.io/?',
          'https://cors-anywhere.herokuapp.com/',
          'https://thingproxy.freeboard.io/fetch/'
        ];
        let html = null, usedProxy = null;
        for (const proxy of proxies){
          try {
            const res = await fetch(proxy + encodeURIComponent(url), { headers: { 'User-Agent':'Mozilla/5.0' } });
            if (res.ok){ html = await res.text(); usedProxy = proxy; break; }
          } catch(_) { /* try next */ }
        }
        if (!html) throw new Error('Impossibile accedere al post. Tutti i proxy hanno fallito.');
        const media = extractMedia(html);
        loadingDiv.style.display = 'none';
        extractBtn.disabled = false; extractBtn.textContent = 'Scansiona Post';
        if (media.length){ showStatus('success', `Trovati ${media.length} media nel post! (Proxy usato: ${usedProxy})`); displayImages(media); }
        else { showStatus('info','Nessun media trovato. Il post potrebbe essere privato.'); showDebugInfo(html.substring(0,2000)+'...'); }
      } catch (err){
        loadingDiv.style.display = 'none';
        extractBtn.disabled = false; extractBtn.textContent = 'Scansiona Post';
        showStatus('error', `Errore: ${err.message}`);
      }
    }

    function extractMedia(html){
      const media = [], seen = new Set();
      const mediaRegexes = [
        /https:\/\/media\.licdn\.com\/dms\/image\/[^"'\s)]+/g,
        /https:\/\/media-exp\d*\.licdn\.com\/[^"'\s)]+/g,
        /https:\/\/dms\.licdn\.com\/[^"'\s)]+/g,
        /src=["']([^"']*(?:jpe?g|png|gif|webp)[^"']*)["']/gi,
        /data-(?:delayed-url|src|background-image)=["']([^"']+)["']/gi,
        /background-image:\s*url\((['"]?)([^'")]+)\1\)/gi,
        /<video[^>]+src=["']([^"']+)["']/gi,
        /<video[^>]+poster=["']([^"']+)["']/gi,
        /https?:\/\/[^"'\s)]*\.(?:jpe?g|png|gif|webp|mp4|mov)(?:\?[^"'\s)]*)?/gi
      ];
      mediaRegexes.forEach((re,i)=>{ let m; while((m=re.exec(html))!==null){ const url=m[1]||m[0]; if(url.startsWith('http')&&!seen.has(url)){ seen.add(url); media.push({url,alt:`Media Regex ${i+1}`,source:`Regex ${i+1}`}); } } });
      try{
        const doc = new DOMParser().parseFromString(html,'text/html');
        doc.querySelectorAll('img').forEach((img,i)=>{ const src=img.src||img.getAttribute('data-delayed-url')||img.getAttribute('data-src'); if(src&&!seen.has(src)){ seen.add(src); media.push({url:src,alt:img.alt||`Immagine ${i+1}`,source:'DOM IMG'}); } });
        doc.querySelectorAll('video').forEach((vid,i)=>{ const src=vid.src||vid.getAttribute('data-src'); const poster=vid.getAttribute('poster'); if(src&&!seen.has(src)){ seen.add(src); media.push({url:src,alt:`Video ${i+1}`,source:'DOM VIDEO'}); } if(poster&&!seen.has(poster)){ seen.add(poster); media.push({url:poster,alt:`Poster video ${i+1}`,source:'DOM VIDEO poster'}); } });
      }catch(e){ console.log('DOM parse fail', e); }
      return media;
    }

    function showStatus(type,msg){ const d=document.createElement('div'); d.className=`status ${type}`; d.textContent=msg; document.getElementById('results').appendChild(d); }

    function displayImages(images){ const grid=document.createElement('div'); grid.className='images-grid'; images.forEach((m,i)=> grid.appendChild(createCard(m,i)) ); document.getElementById('results').appendChild(grid); }

    function noteForProbe(info, url){
      const div = document.createElement('div');
      div.className = 'note warn';
      if (info.status){
        div.textContent = `Errore HTTP ${info.status} ${info.statusText ? '('+info.statusText+')' : ''}`;
      } else {
        // hint specifico per CDN LinkedIn/CORS
        const isLinkedInCdn = /licdn\.com|linkedin\.com/.test(new URL(url).hostname);
        div.textContent = isLinkedInCdn
          ? `Errore di rete/CORS: impossibile verificare lo stato (sessione o referer richiesti dal CDN)`
          : `Errore di rete: ${info.errorMessage || 'Failed to fetch'}`;
      }
      return div;
    }

    function attachErrorDiagnostics(mediaEl, cardEl, url){
      const FALLBACK = getFallbackDataUrl();
      let handled = false; // evita loop
      mediaEl.onerror = async function(){
        if (handled) return; handled = true;
        // disabilita ulteriori onerror
        mediaEl.onerror = null;
        // applica fallback visivo
        if (mediaEl.tagName === 'IMG') mediaEl.src = FALLBACK; else mediaEl.poster = FALLBACK;
        // mostra nota una sola volta per card
        if (!cardEl.dataset.probed){
          cardEl.dataset.probed = '1';
          const info = await probeUrl(url);
          cardEl.appendChild( noteForProbe(info, url) );
        }
      };
    }

    function createCard(m,i){
      const c = document.createElement('div'); c.className='image-card';
      let mediaEl;
      if (/\.(mp4|mov)(\?|$)/i.test(m.url)){
        mediaEl = document.createElement('video');
        mediaEl.src = m.url; mediaEl.controls = true;
        attachErrorDiagnostics(mediaEl, c, m.url);
      } else {
        mediaEl = document.createElement('img');
        mediaEl.src = m.url;
        attachErrorDiagnostics(mediaEl, c, m.url);
      }
      c.appendChild(mediaEl);

      const info = document.createElement('div'); info.className='image-info';
      const urlDiv = document.createElement('div'); urlDiv.className='image-url'; urlDiv.textContent = m.url;
      info.appendChild(urlDiv); c.appendChild(info);

      const acts = document.createElement('div'); acts.className='image-actions';
      const dwn = document.createElement('button'); dwn.className='download-btn'; dwn.textContent='‚¨áÔ∏è Download'; dwn.onclick=()=>downloadImage(m.url,`media-${i+1}`);
      const copy = document.createElement('button'); copy.className='copy-btn'; copy.textContent='üìã Copia URL'; copy.onclick=()=>copyToClipboard(m.url);
      const open = document.createElement('button'); open.className='open-btn'; open.textContent='üîó Apri'; open.onclick=()=>window.open(m.url,'_blank');
      acts.appendChild(dwn); acts.appendChild(copy); acts.appendChild(open);
      c.appendChild(acts);
      return c;
    }

    async function downloadImage(url,filename){
      try { const a=document.createElement('a'); a.href=url; a.download=filename; a.target='_blank'; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
      catch(_) { window.open(url,'_blank'); }
    }

    function copyToClipboard(text){
      navigator.clipboard.writeText(text).then(()=>alert('URL copiato!')).catch(()=>{
        const t=document.createElement('textarea'); t.value=text; document.body.appendChild(t); t.select(); document.execCommand('copy'); document.body.removeChild(t); alert('URL copiato!');
      });
    }

    function showDebugInfo(html){ const d=document.createElement('div'); d.className='debug-info'; d.innerHTML='<strong>Debug HTML:</strong><br><pre>'+html.replace(/</g,'&lt;').replace(/>/g,'&gt;')+'</pre>'; document.getElementById('results').appendChild(d); }

    document.getElementById('linkedinUrl').addEventListener('keypress', e=>{ if (e.key==='Enter') extractImages(); });
  </script>
</body>
</html>